<form [formGroup]="stageForm" (ngSubmit)="onSubmit()" class="max-w-md mx-auto p-6 bg-white rounded-lg shadow-md">
  <h2 class="text-xl font-bold mb-4">
    {{ isEditMode ? 'Edit Stage' : 'Create Stage for Job' }}
  </h2>
  <!-- Job No -->
  <div class="mb-4">
    <label for="jobNoSelect" class="block text-gray-700 mb-2">Job No</label>
    <select id="jobNoSelect" formControlName="jobNo" class="w-full p-2 border rounded" [disabled]="isEditMode">
      <option value="">Select Job</option>
      <option *ngFor="let job of jobs" [value]="job.jobno">{{ job.jobno }} - {{ job.jobdescription }}</option>
    </select>
    <div *ngIf="stageForm.get('jobNo')?.invalid && stageForm.get('jobNo')?.touched" class="text-red-500 text-sm">
      Job No is required
    </div>
  </div>
  <!-- Stage No -->
  <div class="mb-4">
    <label for="stageNoInput" class="block text-gray-700 mb-2">Stage No</label>
    <input id="stageNoInput" type="number" formControlName="stageNo" class="w-full p-2 border rounded" min="1"
      [disabled]="isEditMode" />
    <div
      *ngIf="(stageForm.get('stageNo')?.invalid && stageForm.get('stageNo')?.touched) || stageForm.errors?.['stageNumberNotUnique']"
      class="text-red-500 text-sm">
      <span *ngIf="stageForm.get('stageNo')?.errors?.['required']">Stage number is required</span>
      <span *ngIf="stageForm.get('stageNo')?.errors?.['min']">Must be at least 1</span>
      <span *ngIf="stageForm.errors?.['stageNumberNotUnique']">Stage already exists for this job</span>
    </div>
  </div>

  <!-- Stage Description -->
  <div class="mb-4">
    <label for="stageDescInput" class="block text-gray-700 mb-2">Stage Description</label>
    <input id="stageDescInput" type="text" formControlName="stageDesc" class="w-full p-2 border rounded"
      maxlength="20" />
    <div *ngIf="stageForm.get('stageDesc')?.invalid && stageForm.get('stageDesc')?.touched"
      class="text-red-500 text-sm">
      <span *ngIf="stageForm.get('stageDesc')?.errors?.['required']">Description is required</span>
      <span *ngIf="stageForm.get('stageDesc')?.errors?.['maxlength']">Maximum 20 characters allowed</span>
    </div>
  </div>

  <!-- Preceding Stage -->
  <div class="mb-4">
    <label for="precedingStageSelect" class="block text-gray-700 mb-2">Preceding Stage</label>
    <select id="precedingStageSelect" formControlName="precedingStage" class="w-full p-2 border rounded">
      <option value="---">---</option>
      <option *ngFor="let stage of existingStages" [value]="stage.stageNo"
        [hidden]="stage.stageNo >= (stageForm.get('stageNo')?.value || Infinity)">
        {{ stage.stageNo }} - {{ stage.stageDesc }}
      </option>
    </select>
  </div>

  <!-- Start Date -->
  <div class="mb-4">
    <label for="startDateInput" class="block text-gray-700 mb-2">Start Date</label>
    <input id="startDateInput" type="date" formControlName="startDate" [min]="minStartDate"
      class="w-full p-2 border rounded" />
    <div *ngIf="stageForm.get('startDate')?.invalid && stageForm.get('startDate')?.touched"
      class="text-red-500 text-sm">
      <span *ngIf="stageForm.get('startDate')?.errors?.['required']">Start date is required</span>
      <span *ngIf="stageForm.get('startDate')?.errors?.['invalidStartDate']">Cannot be before QC start date</span>
      <span *ngIf="stageForm.get('startDate')?.errors?.['startDateBeforePreceding']">Must be after preceding stage's end
        date</span>
    </div>
  </div>

  <!-- End Date -->
  <div class="mb-4">
    <label for="endDateInput" class="block text-gray-700 mb-2">End Date</label>
    <input id="endDateInput" type="date" formControlName="endDate" class="w-full p-2 border rounded" />
    <div *ngIf="stageForm.get('endDate')?.invalid && stageForm.get('endDate')?.touched" class="text-red-500 text-sm">
      <span *ngIf="stageForm.get('endDate')?.errors?.['required']">End date is required</span>
    </div>
    <div *ngIf="stageForm.errors?.['dateRangeInvalid'] && stageForm.touched" class="text-red-500 text-sm">
      End date must be after start date
    </div>
  </div>

  <!-- QAP -->
  <div class="mb-4">
    <label for="qapSelect" class="block text-gray-700 mb-2">QAP</label>
    <select id="qapSelect" formControlName="qap" class="w-full p-2 border rounded">
      <option value="">Select QAP</option>
      <option *ngFor="let qap of filteredQAPs" [value]="qap.qapName">{{ qap.qapName }}</option>
    </select>
    <div *ngIf="stageForm.get('qap')?.invalid && stageForm.get('qap')?.touched" class="text-red-500 text-sm">
      QAP selection is required
    </div>
  </div>

  <!-- Submit Button -->
  <div class="mt-6">
    <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 transition">
      {{ isEditMode ? 'Update' : 'Submit' }}
    </button>
  </div>
</form>
